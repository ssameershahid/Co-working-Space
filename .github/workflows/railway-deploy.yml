name: Deploy to Railway

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Railway CLI
        run: npm i -g @railway/cli@latest

      - name: Validate Railway secrets present
        shell: bash
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then echo "RAILWAY_TOKEN missing"; exit 1; fi
          if [ -z "$RAILWAY_PROJECT_ID" ]; then echo "RAILWAY_PROJECT_ID missing"; exit 1; fi

      - name: Authenticate to Railway (token)
        shell: bash
        run: |
          railway logout || true
          railway login --token "$RAILWAY_TOKEN"
          railway whoami

      - name: Link Railway project
        run: |
          railway link -p "$RAILWAY_PROJECT_ID"

      - name: Configure environment variables (if provided)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
        run: |
          set -e
          [ -n "$DATABASE_URL" ] && railway variables set DATABASE_URL="$DATABASE_URL" || true
          [ -n "$SESSION_SECRET" ] && railway variables set SESSION_SECRET="$SESSION_SECRET" || true
          [ -n "$RESEND_API_KEY" ] && railway variables set RESEND_API_KEY="$RESEND_API_KEY" || true
          [ -n "$VAPID_PUBLIC_KEY" ] && railway variables set VAPID_PUBLIC_KEY="$VAPID_PUBLIC_KEY" || true
          [ -n "$VAPID_PRIVATE_KEY" ] && railway variables set VAPID_PRIVATE_KEY="$VAPID_PRIVATE_KEY" || true

      - name: Deploy (Dockerfile build)
        run: |
          railway up --ci || railway up


